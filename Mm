# namos_complete.py
import os
import json
import uuid
import hashlib
import secrets
from datetime import datetime, timedelta
from flask import Flask, render_template_string, request, jsonify, redirect, session, send_file
from flask_sqlalchemy import SQLAlchemy
from werkzeug.security import generate_password_hash, check_password_hash
import smtplib
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart

# ============ APP SETUP ============
app = Flask(__name__)
app.secret_key = 'namos-secret-key-2024-restaurant-system'
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///namos.db'
app.config['SQLALCHEMY_TRACK_MODIFICATIONS'] = False
app.config['UPLOAD_FOLDER'] = 'uploads'

db = SQLAlchemy(app)
os.makedirs('uploads', exist_ok=True)

# ============ DATABASE MODELS ============

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    email = db.Column(db.String(120), unique=True, nullable=False)
    username = db.Column(db.String(80), unique=True, nullable=False)
    password = db.Column(db.String(200), nullable=False)
    full_name = db.Column(db.String(100))
    profile_image = db.Column(db.String(200), default='default.png')
    phone = db.Column(db.String(20))
    bio = db.Column(db.Text)
    is_verified = db.Column(db.Boolean, default=False)
    verification_code = db.Column(db.String(10))
    department = db.Column(db.String(50))  # Bar, K√ºche, Service, Admin
    role = db.Column(db.String(20), default='staff')
    is_active = db.Column(db.Boolean, default=True)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    
    # Relationships
    sent_messages = db.relationship('Message', foreign_keys='Message.sender_id', backref='message_sender', lazy=True)
    received_messages = db.relationship('Message', foreign_keys='Message.receiver_id', backref='message_receiver', lazy=True)
    posts = db.relationship('Post', backref='author', lazy=True)

class Room(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    name = db.Column(db.String(50), unique=True, nullable=False)  # Bar, K√ºche, Service, Admin, Public
    password = db.Column(db.String(200))
    description = db.Column(db.Text)
    is_locked = db.Column(db.Boolean, default=True)
    max_users = db.Column(db.Integer, default=50)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class RoomMember(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    room_id = db.Column(db.Integer, db.ForeignKey('room.id'), nullable=False)
    joined_at = db.Column(db.DateTime, default=datetime.utcnow)
    is_admin = db.Column(db.Boolean, default=False)

class Message(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    sender_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    receiver_id = db.Column(db.Integer, db.ForeignKey('user.id'))
    room_id = db.Column(db.Integer, db.ForeignKey('room.id'))
    content = db.Column(db.Text, nullable=False)
    message_type = db.Column(db.String(20), default='text')  # text, image, file
    file_url = db.Column(db.String(300))
    is_read = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Post(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    room_id = db.Column(db.Integer, db.ForeignKey('room.id'))
    content = db.Column(db.Text, nullable=False)
    image_url = db.Column(db.String(300))
    likes = db.Column(db.Integer, default=0)
    comments_count = db.Column(db.Integer, default=0)
    is_poll = db.Column(db.Boolean, default=False)
    poll_options = db.Column(db.Text)  # JSON string
    poll_votes = db.Column(db.Text)  # JSON string
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Reservation(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    customer_name = db.Column(db.String(100), nullable=False)
    customer_phone = db.Column(db.String(20), nullable=False)
    customer_email = db.Column(db.String(120))
    table_number = db.Column(db.String(10), nullable=False)
    persons = db.Column(db.Integer, nullable=False)
    reservation_date = db.Column(db.Date, nullable=False)
    reservation_time = db.Column(db.Time, nullable=False)
    status = db.Column(db.String(20), default='confirmed')
    notes = db.Column(db.Text)
    created_by = db.Column(db.Integer, db.ForeignKey('user.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class Order(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    table_number = db.Column(db.String(10), nullable=False)
    items = db.Column(db.Text, nullable=False)  # JSON string
    status = db.Column(db.String(20), default='pending')
    department = db.Column(db.String(20), nullable=False)  # Bar, K√ºche
    priority = db.Column(db.String(10), default='normal')
    notes = db.Column(db.Text)
    assigned_to = db.Column(db.Integer, db.ForeignKey('user.id'))
    created_at = db.Column(db.DateTime, default=datetime.utcnow)
    completed_at = db.Column(db.DateTime)

class Notification(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    title = db.Column(db.String(100), nullable=False)
    message = db.Column(db.Text, nullable=False)
    notification_type = db.Column(db.String(20))  # info, warning, success, error
    is_read = db.Column(db.Boolean, default=False)
    created_at = db.Column(db.DateTime, default=datetime.utcnow)

class PollVote(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    poll_id = db.Column(db.Integer, db.ForeignKey('post.id'), nullable=False)
    user_id = db.Column(db.Integer, db.ForeignKey('user.id'), nullable=False)
    option_index = db.Column(db.Integer, nullable=False)
    voted_at = db.Column(db.DateTime, default=datetime.utcnow)

# ============ HTML TEMPLATES ============

BASE_CSS = """
:root {
    --primary: #667eea;
    --primary-dark: #5a67d8;
    --secondary: #764ba2;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --info: #3b82f6;
    --dark: #1e293b;
    --light: #f8fafc;
    --gray: #6b7280;
    --gray-light: #e5e7eb;
}

* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
}

body {
    background: #fafafa;
    color: #262626;
    min-height: 100vh;
}

.navbar {
    background: white;
    border-bottom: 1px solid #dbdbdb;
    padding: 0 20px;
    position: fixed;
    top: 0;
    width: 100%;
    z-index: 1000;
}

.nav-content {
    max-width: 975px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    height: 54px;
}

.logo {
    font-size: 24px;
    font-weight: 800;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-decoration: none;
}

.nav-links {
    display: flex;
    gap: 22px;
    align-items: center;
}

.nav-link {
    color: #262626;
    text-decoration: none;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 6px;
}

.nav-link.active {
    color: #262626;
}

.nav-link:hover {
    color: #8e8e8e;
}

.user-avatar {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    object-fit: cover;
}

.container {
    max-width: 975px;
    margin: 80px auto 20px;
    padding: 0 20px;
}

.card {
    background: white;
    border: 1px solid #dbdbdb;
    border-radius: 12px;
    padding: 24px;
    margin-bottom: 20px;
}

.btn {
    padding: 8px 24px;
    border-radius: 8px;
    border: none;
    font-weight: 600;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.2s;
    text-decoration: none;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
}

.btn-primary {
    background: var(--primary);
    color: white;
}

.btn-primary:hover {
    background: var(--primary-dark);
    transform: translateY(-1px);
}

.btn-outline {
    background: transparent;
    border: 1px solid #dbdbdb;
    color: #262626;
}

.btn-outline:hover {
    background: #fafafa;
}

.input-group {
    margin-bottom: 20px;
}

.input-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #262626;
    font-size: 14px;
}

.form-input {
    width: 100%;
    padding: 12px;
    border: 1px solid #dbdbdb;
    border-radius: 8px;
    font-size: 14px;
    background: #fafafa;
}

.form-input:focus {
    outline: none;
    border-color: #a5b4fc;
    background: white;
}

.rooms-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 20px;
    margin-top: 20px;
}

.room-card {
    background: white;
    border: 1px solid #dbdbdb;
    border-radius: 12px;
    padding: 20px;
    text-decoration: none;
    color: inherit;
    transition: all 0.2s;
}

.room-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.room-icon {
    font-size: 32px;
    margin-bottom: 12px;
}

.room-name {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 8px;
}

.room-desc {
    color: #8e8e8e;
    font-size: 14px;
    margin-bottom: 16px;
}

.room-stats {
    display: flex;
    gap: 16px;
    font-size: 13px;
    color: #8e8e8e;
}

.message-container {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-height: 500px;
    overflow-y: auto;
    padding: 16px;
    background: #fafafa;
    border-radius: 8px;
}

.message-bubble {
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
}

.message-sent {
    background: var(--primary);
    color: white;
    align-self: flex-end;
    border-bottom-right-radius: 4px;
}

.message-received {
    background: white;
    border: 1px solid #dbdbdb;
    align-self: flex-start;
    border-bottom-left-radius: 4px;
}

.message-sender {
    font-weight: 600;
    margin-bottom: 4px;
    font-size: 13px;
}

.message-content {
    margin-bottom: 4px;
}

.message-time {
    font-size: 11px;
    opacity: 0.7;
    text-align: right;
}

.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 24px;
}

.stat-card {
    background: white;
    border: 1px solid #dbdbdb;
    border-radius: 12px;
    padding: 20px;
    text-align: center;
}

.stat-value {
    font-size: 32px;
    font-weight: 700;
    margin-bottom: 8px;
    background: linear-gradient(45deg, #667eea, #764ba2);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.stat-label {
    color: #8e8e8e;
    font-size: 14px;
}

.notification-badge {
    background: var(--danger);
    color: white;
    font-size: 12px;
    padding: 2px 6px;
    border-radius: 10px;
    position: absolute;
    top: -5px;
    right: -5px;
}

.profile-header {
    display: flex;
    align-items: center;
    gap: 28px;
    margin-bottom: 24px;
}

.profile-avatar {
    width: 150px;
    height: 150px;
    border-radius: 50%;
    object-fit: cover;
    border: 3px solid white;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.profile-info h2 {
    font-size: 28px;
    margin-bottom: 8px;
}

.profile-bio {
    color: #8e8e8e;
    margin-bottom: 16px;
}

.profile-stats {
    display: flex;
    gap: 24px;
}

.profile-stat {
    text-align: center;
}

.profile-stat-value {
    font-size: 18px;
    font-weight: 700;
    display: block;
}

.profile-stat-label {
    font-size: 12px;
    color: #8e8e8e;
}

@media (max-width: 768px) {
    .container {
        padding: 0 16px;
    }
    
    .rooms-grid {
        grid-template-columns: 1fr;
    }
    
    .profile-header {
        flex-direction: column;
        text-align: center;
    }
}
"""

LOGIN_HTML = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namos - Login</title>
    <style>{BASE_CSS}</style>
    <style>
        .login-container {{
            max-width: 350px;
            margin: 100px auto;
        }}
        
        .login-card {{
            background: white;
            border: 1px solid #dbdbdb;
            border-radius: 12px;
            padding: 40px;
            text-align: center;
        }}
        
        .logo-large {{
            font-size: 48px;
            font-weight: 800;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 30px;
        }}
        
        .login-form {{
            margin-top: 30px;
        }}
        
        .divider {{
            margin: 20px 0;
            position: relative;
            text-align: center;
            color: #8e8e8e;
        }}
        
        .divider::before {{
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 1px;
            background: #dbdbdb;
        }}
        
        .divider span {{
            background: white;
            padding: 0 20px;
            position: relative;
        }}
        
        .google-btn {{
            background: white;
            border: 1px solid #dbdbdb;
            color: #262626;
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }}
        
        .google-btn:hover {{
            background: #fafafa;
        }}
        
        .signup-link {{
            margin-top: 20px;
            padding: 20px;
            border: 1px solid #dbdbdb;
            border-radius: 12px;
            background: white;
        }}
        
        .error-message {{
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
        }}
    </style>
</head>
<body>
    <div class="login-container">
        <div class="login-card">
            <div class="logo-large">Namos</div>
            <p style="color: #8e8e8e; margin-bottom: 30px;">Restaurant Management System</p>
            
            {{% if error %}}
            <div class="error-message">{{error}}</div>
            {{% endif %}}
            
            <form method="POST" action="/login" class="login-form">
                <div class="input-group">
                    <input type="email" name="email" class="form-input" placeholder="Email" required>
                </div>
                
                <div class="input-group">
                    <input type="password" name="password" class="form-input" placeholder="Password" required>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">Log In</button>
            </form>
            
            <div class="divider">
                <span>OR</span>
            </div>
            
            <button class="google-btn" onclick="loginWithGoogle()">
                <svg width="18" height="18" viewBox="0 0 24 24">
                    <path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/>
                    <path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/>
                    <path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/>
                    <path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/>
                </svg>
                Continue with Google
            </button>
            
            <div style="text-align: center; margin-top: 20px;">
                <a href="/forgot-password" style="color: #667eea; text-decoration: none; font-size: 14px;">Forgot password?</a>
            </div>
        </div>
        
        <div class="signup-link">
            Don't have an account? <a href="/register" style="color: #667eea; text-decoration: none; font-weight: 600;">Sign up</a>
        </div>
    </div>
    
    <script>
        function loginWithGoogle() {{
            window.location.href = '/auth/google';
        }}
    </script>
</body>
</html>
"""

DASHBOARD_HTML = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namos - Dashboard</title>
    <style>{BASE_CSS}</style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar">
        <div class="nav-content">
            <a href="/dashboard" class="logo">Namos</a>
            
            <div class="nav-links">
                <a href="/dashboard" class="nav-link active">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/>
                    </svg>
                    Home
                </a>
                <a href="/rooms" class="nav-link">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                    </svg>
                    Rooms
                </a>
                <a href="/messages" class="nav-link">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/>
                    </svg>
                    Messages
                </a>
                <a href="/reservations" class="nav-link">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/>
                    </svg>
                    Reservations
                </a>
                <a href="/profile" class="nav-link">
                    {{% if user.profile_image %}}
                    <img src="/uploads/{{{{user.profile_image}}}}" class="user-avatar">
                    {{% else %}}
                    <div style="width: 24px; height: 24px; border-radius: 50%; background: #667eea; color: white; display: flex; align-items: center; justify-content: center; font-size: 12px;">
                        {{{{user.full_name[0] if user.full_name else 'U'}}}}
                    </div>
                    {{% endif %}}
                    Profile
                </a>
                <a href="/logout" class="nav-link">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/>
                    </svg>
                </a>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container">
        <!-- Welcome Section -->
        <div class="card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <h1 style="margin-bottom: 10px;">Welcome back, {{{{user.full_name or user.username}}}}! üëã</h1>
            <p style="opacity: 0.9;">Here's what's happening in your restaurant today.</p>
        </div>

        <!-- Stats Section -->
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-value">{{{{stats.today_reservations}}}}</div>
                <div class="stat-label">Today's Reservations</div>
                <div style="font-size: 12px; color: #10b981; margin-top: 5px;">
                    {{{{stats.today_persons}}}} persons
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{{{stats.tomorrow_reservations}}}}</div>
                <div class="stat-label">Tomorrow's Reservations</div>
                <div style="font-size: 12px; color: #10b981; margin-top: 5px;">
                    {{{{stats.tomorrow_persons}}}} persons
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{{{stats.active_orders}}}}</div>
                <div class="stat-label">Active Orders</div>
                <div style="font-size: 12px; color: #f59e0b; margin-top: 5px;">
                    {{{{stats.urgent_orders}}}} urgent
                </div>
            </div>
            
            <div class="stat-card">
                <div class="stat-value">{{{{stats.unread_messages}}}}</div>
                <div class="stat-label">Unread Messages</div>
                <div style="font-size: 12px; color: #3b82f6; margin-top: 5px;">
                    {{{{stats.room_messages}}}} in rooms
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="card">
            <h2 style="margin-bottom: 20px;">Quick Actions</h2>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
                <a href="/reservations/new" class="btn btn-primary">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/>
                    </svg>
                    New Reservation
                </a>
                <a href="/orders/new" class="btn btn-outline">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                    </svg>
                    Create Order
                </a>
                <a href="/rooms" class="btn btn-outline">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm0 12H4V8h16v10z"/>
                    </svg>
                    Join Room
                </a>
                <a href="/messages" class="btn btn-outline">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/>
                    </svg>
                    Send Message
                </a>
            </div>
        </div>

        <!-- Recent Activity -->
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2>Recent Activity</h2>
                <a href="/activity" style="color: #667eea; text-decoration: none; font-size: 14px;">View all</a>
            </div>
            
            {{% if recent_activity %}}
            <div style="display: flex; flex-direction: column; gap: 16px;">
                {{% for activity in recent_activity %}}
                <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #fafafa; border-radius: 8px;">
                    <div style="width: 40px; height: 40px; border-radius: 50%; background: #e5e7eb; display: flex; align-items: center; justify-content: center;">
                        {{% if activity.type == 'reservation' %}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#667eea">
                            <path d="M17 12h-5v5h5v-5zM16 1v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2h-1V1h-2zm3 18H5V8h14v11z"/>
                        </svg>
                        {{% elif activity.type == 'order' %}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#10b981">
                            <path d="M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4V7zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/>
                        </svg>
                        {{% elif activity.type == 'message' %}}
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="#3b82f6">
                            <path d="M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8l8 5 8-5v10zm-8-7L4 6h16l-8 5z"/>
                        </svg>
                        {{% endif %}}
                    </div>
                    <div style="flex: 1;">
                        <div style="font-weight: 600; font-size: 14px;">{{{{activity.title}}}}</div>
                        <div style="color: #6b7280; font-size: 13px;">{{{{activity.description}}}}</div>
                    </div>
                    <div style="color: #9ca3af; font-size: 12px;">{{{{activity.time}}}}</div>
                </div>
                {{% endfor %}}
            </div>
            {{% else %}}
            <div style="text-align: center; padding: 40px; color: #9ca3af;">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="currentColor" style="opacity: 0.5; margin-bottom: 16px;">
                    <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                </svg>
                <p>No recent activity</p>
            </div>
            {{% endif %}}
        </div>
    </div>
</body>
</html>
"""

ROOMS_HTML = f"""
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Namos - Rooms</title>
    <style>{BASE_CSS}</style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-content">
            <a href="/dashboard" class="logo">Namos</a>
            <div class="nav-links">
                <a href="/dashboard" class="nav-link">Home</a>
                <a href="/rooms" class="nav-link active">Rooms</a>
                <a href="/messages" class="nav-link">Messages</a>
                <a href="/reservations" class="nav-link">Reservations</a>
                <a href="/profile" class="nav-link">Profile</a>
                <a href="/logout" class="nav-link">Logout</a>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="card">
            <h1 style="margin-bottom: 5px;">Rooms</h1>
            <p style="color: #6b7280; margin-bottom: 20px;">Join department rooms to collaborate with your team</p>
            
            <div class="rooms-grid">
                <!-- Bar Room -->
                <a href="/room/bar" class="room-card">
                    <div class="room-icon" style="color: #10b981;">üç∏</div>
                    <div class="room-name">Bar</div>
                    <div class="room-desc">Drinks preparation and service. All bar staff coordination.</div>
                    <div class="room-stats">
                        <span>üîí Password protected</span>
                        <span>{{{{room_stats.bar}}}} members</span>
                    </div>
                </a>
                
                <!-- K√ºche Room -->
                <a href="/room/k√ºche" class="room-card">
                    <div class="room-icon" style="color: #f59e0b;">üë®‚Äçüç≥</div>
                    <div class="room-name">K√ºche</div>
                    <div class="room-desc">Kitchen operations. Food preparation and cooking.</div>
                    <div class="room-stats">
                        <span>üîí Password protected</span>
                        <span>{{{{room_stats.k√ºche}}}} members</span>
                    </div>
                </a>
                
                <!-- Service Room -->
                <a href="/room/service" class="room-card">
                    <div class="room-icon" style="color: #3b82f6;">üíÅ</div>
                    <div class="room-name">Service</div>
                    <div class="room-desc">Customer service and table management.</div>
                    <div class="room-stats">
                        <span>üîí Password protected</span>
                        <span>{{{{room_stats.service}}}} members</span>
                    </div>
                </a>
                
                <!-- Admin Room -->
                <a href="/room/admin" class="room-card">
                    <div class="room-icon" style="color: #667eea;">üëë</div>
                    <div class="room-name">Admin</div>
                    <div class="room-desc">Management and system administration.</div>
                    <div class="room-stats">
                        <span>üîí Password protected</span>
                        <span>{{{{room_stats.admin}}}} members</span>
                    </div>
                </a>
                
                <!-- Public Room -->
                <a href="/room/public" class="room-card">
                    <div class="room-icon" style="color: #8b5cf6;">üåç</div>
                    <div class="room-name">Public</div>
                    <div class="room-desc">General discussions and announcements.</div>
                    <div class="room-stats">
                        <span>üîì Open access</span>
                        <span>{{{{room_stats.public}}}} members</span>
                    </div>
                </a>
            </div>
        </div>
        
        <!-- Room Password Management (Admin only) -->
        {{% if user.role == 'admin' %}}
        <div class="card">
            <h2 style="margin-bottom: 20px;">Room Password Management</h2>
            <div style="display: grid; gap: 16px;">
                {{% for room in ['Bar', 'K√ºche', 'Service', 'Admin'] %}}
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 16px; background: #f8fafc; border-radius: 8px;">
                    <div>
                        <div style="font-weight: 600;">{{{{room}}}} Room</div>
                        <div style="font-size: 14px; color: #6b7280;">Change room password</div>
                    </div>
                    <button onclick="changePassword('{{{{room.lower()}}}}')" class="btn btn-outline">Change Password</button>
                </div>
                {{% endfor %}}
            </div>
        </div>
        {{% endif %}}
    </div>
    
    <script>
        function changePassword(roomName) {{
            const newPassword = prompt(`Enter new password for ${{roomName}} room:`);
            if (newPassword && newPassword.length >= 4) {{
                fetch('/api/room/' + roomName + '/password', {{
                    method: 'POST',
                    headers: {{ 'Content-Type': 'application/json' }},
                    body: JSON.stringify({{ password: newPassword }})
                }})
                .then(response => response.json())
                .then(data => {{
                    if (data.success) {{
                        alert('Password changed successfully!');
                    }} else {{
                        alert('Error: ' + data.error);
                    }}
                }});
            }}
        }}
    </script>
</body>
</html>
"""

# ============ HELPER FUNCTIONS ============

def create_default_rooms():
    """Create default rooms if they don't exist"""
    rooms = [
        {'name': 'Bar', 'password': 'bar123', 'description': 'Bar department room'},
        {'name': 'K√ºche', 'password': 'kitchen123', 'description': 'Kitchen department room'},
        {'name': 'Service', 'password': 'service123', 'description': 'Service department room'},
        {'name': 'Admin', 'password': 'admin123', 'description': 'Administration room'},
        {'name': 'Public', 'password': None, 'description': 'Public discussion room', 'is_locked': False}
    ]
    
    for room_data in rooms:
        if not Room.query.filter_by(name=room_data['name']).first():
            room = Room(
                name=room_data['name'],
                password=generate_password_hash(room_data['password']) if room_data['password'] else None,
                description=room_data['description'],
                is_locked=room_data.get('is_locked', True)
            )
            db.session.add(room)
    
    db.session.commit()

def get_stats():
    """Get dashboard statistics"""
    today = datetime.now().date()
    tomorrow = today + timedelta(days=1)
    
    today_res = Reservation.query.filter_by(reservation_date=today).all()
    tomorrow_res = Reservation.query.filter_by(reservation_date=tomorrow).all()
    active_orders = Order.query.filter(Order.status.in_(['pending', 'preparing'])).all()
    urgent_orders = Order.query.filter_by(priority='urgent', status='pending').count()
    
    return {
        'today_reservations': len(today_res),
        'today_persons': sum(r.persons for r in today_res),
        'tomorrow_reservations': len(tomorrow_res),
        'tomorrow_persons': sum(r.persons for r in tomorrow_res),
        'active_orders': len(active_orders),
        'urgent_orders': urgent_orders,
        'unread_messages': 0,
        'room_messages': 0
    }

def send_verification_email(email, code):
    """Send verification email (simplified for demo)"""
    print(f"[EMAIL] Verification code for {email}: {code}")
    return True

# ============ ROUTES ============

@app.route('/')
def index():
    return redirect('/login')

@app.route('/login', methods=['GET', 'POST'])
def login():
    if request.method == 'POST':
        email = request.form.get('email')
        password = request.form.get('password')
        
        user = User.query.filter_by(email=email).first()
        
        if user and check_password_hash(user.password, password):
            if not user.is_verified:
                return render_template_string(LOGIN_HTML, error="Please verify your email first")
            
            if not user.is_active:
                return render_template_string(LOGIN_HTML, error="Account is deactivated")
            
            session['user_id'] = user.id
            session['username'] = user.username
            session['role'] = user.role
            session['department'] = user.department
            
            user.last_login = datetime.utcnow()
            db.session.commit()
            
            return redirect('/dashboard')
        else:
            return render_template_string(LOGIN_HTML, error="Invalid email or password")
    
    return render_template_string(LOGIN_HTML)

@app.route('/register', methods=['GET', 'POST'])
def register():
    if request.method == 'POST':
        email = request.form.get('email')
        username = request.form.get('username')
        password = request.form.get('password')
        full_name = request.form.get('full_name')
        
        # Check if user exists
        if User.query.filter_by(email=email).first():
            return "Email already registered", 400
        if User.query.filter_by(username=username).first():
            return "Username already taken", 400
        
        # Create user
        user = User(
            email=email,
            username=username,
            password=generate_password_hash(password),
            full_name=full_name,
            verification_code=str(secrets.randbelow(1000000)).zfill(6),
            is_verified=False
        )
        
        db.session.add(user)
        db.session.commit()
        
        # Send verification email
        send_verification_email(email, user.verification_code)
        
        return redirect(f'/verify/{user.id}')
    
    return """
    <!DOCTYPE html>
    <html>
    <head><title>Register</title></head>
    <body>
        <h1>Register</h1>
        <form method="POST">
            <input type="email" name="email" placeholder="Email" required><br>
            <input type="text" name="username" placeholder="Username" required><br>
            <input type="password" name="password" placeholder="Password" required><br>
            <input type="text" name="full_name" placeholder="Full Name"><br>
            <button type="submit">Register</button>
        </form>
    </body>
    </html>
    """

@app.route('/verify/<int:user_id>', methods=['GET', 'POST'])
def verify_email(user_id):
    user = User.query.get(user_id)
    if not user:
        return "User not found", 404
    
    if request.method == 'POST':
        code = request.form.get('code')
        if code == user.verification_code:
            user.is_verified = True
            user.verification_code = None
            db.session.commit()
            return redirect('/login')
    
    return f"""
    <!DOCTYPE html>
    <html>
    <head><title>Verify Email</title></head>
    <body>
        <h1>Verify Email</h1>
        <p>Check your email for verification code</p>
        <form method="POST">
            <input type="text" name="code" placeholder="Verification Code" required>
            <button type="submit">Verify</button>
        </form>
    </body>
    </html>
    """

@app.route('/dashboard')
def dashboard():
    if 'user_id' not in session:
        return redirect('/login')
    
    user = User.query.get(session['user_id'])
    if not user:
        return redirect('/login')
    
    stats = get_stats()
    recent_activity = []
    
    return render_template_string(DASHBOARD_HTML, user=user, stats=stats, recent_activity=recent_activity)

@app.route('/rooms')
def rooms():
    if 'user_id' not in session:
        return redirect('/login')
    
    user = User.query.get(session['user_id'])
    if not user:
        return redirect('/login')
    
    # Get room stats
    room_stats = {}
    for room_name in ['Bar', 'K√ºche', 'Service', 'Admin', 'Public']:
        room = Room.query.filter_by(name=room_name).first()
        if room:
            room_stats[room_name.lower()] = RoomMember.query.filter_by(room_id=room.id).count()
        else:
            room_stats[room_name.lower()] = 0
    
    return render_template_string(ROOMS_HTML, user=user, room_stats=room_stats)

@app.route('/room/<room_name>')
def room(room_name):
    if 'user_id' not in session:
        return redirect('/login')
    
    user = User.query.get(session['user_id'])
    if not user:
        return redirect('/login')
    
    room = Room.query.filter_by(name=room_name.capitalize()).first()
    if not room:
        return "Room not found", 404
    
    # Check if user is member
    is_member = RoomMember.query.filter_by(user_id=user.id, room_id=room.id).first()
    
    # If room is locked and not member, show password prompt
    if room.is_locked and not is_member:
        return f"""
        <!DOCTYPE html>
        <html>
        <head><title>Enter Password</title></head>
        <body>
            <h1>{room.name} Room</h1>
            <p>This room requires a password</p>
            <form method="POST" action="/room/{room_name}/join">
                <input type="password" name="password" placeholder="Room Password" required>
                <button type="submit">Join Room</button>
            </form>
        </body>
        </html>
        """
    
    # If not member, add to room
    if not is_member:
        member = RoomMember(user_id=user.id, room_id=room.id)
        db.session.add(member)
        db.session.commit()
    
    # Get room messages
    messages = Message.query.filter_by(room_id=room.id).order_by(Message.created_at.desc()).limit(50).all()
    
    return f"""
    <!DOCTYPE html>
    <html>
    <head>
        <title>{room.name} Room</title>
        <style>{BASE_CSS}</style>
    </head>
    <body>
        <nav class="navbar">
            <div class="nav-content">
                <a href="/rooms" class="logo">‚Üê Back</a>
                <div style="font-weight: 600;">{room.name} Room</div>
            </div>
        </nav>
        
        <div class="container">
            <div class="card">
                <h2>{room.name}</h2>
                <p style="color: #6b7280;">{room.description}</p>
                
                <div class="message-container">
                    {''.join([f'''
                    <div class="message-bubble {'message-sent' if m.sender_id == user.id else 'message-received'}">
                        <div class="message-sender">{User.query.get(m.sender_id).username if User.query.get(m.sender_id) else 'Unknown'}</div>
                        <div class="message-content">{m.content}</div>
                        <div class="message-time">{m.created_at.strftime('%H:%M')}</div>
                    </div>
                    ''' for m in reversed(messages)])}
                </div>
                
                <form method="POST" action="/room/{room_name}/message" style="margin-top: 20px;">
                    <div style="display: flex; gap: 10px;">
                        <input type="text" name="message" class="form-input" placeholder="Type your message..." required>
                        <button type="submit" class="btn btn-primary">Send</button>
                    </div>
                </form>
            </div>
        </div>
    </body>
    </html>
    """

@app.route('/room/<room_name>/join', methods=['POST'])
def join_room(room_name):
    if 'user_id' not in session:
        return redirect('/login')
    
    user = User.query.get(session['user_id'])
    room = Room.query.filter_by(name=room_name.capitalize()).first()
    
    if not room:
        return "Room not found", 404
    
    password = request.form.get('password')
    
    if room.is_locked and not check_password_hash(room.password, password):
        return "Invalid password", 403
    
    # Add user to room
    member = RoomMember(user_id=user.id, room_id=room.id)
    db.session.add(member)
    db.session.commit()
    
    return redirect(f'/room/{room_name}')

@app.route('/room/<room_name>/message', methods=['POST'])
def send_room_message(room_name):
    if 'user_id' not in session:
        return redirect('/login')
    
    user = User.query.get(session['user_id'])
    room = Room.query.filter_by(name=room_name.capitalize()).first()
    
    if not room:
        return "Room not found", 404
    
    # Check if user is member
    if not RoomMember.query.filter_by(user_id=user.id, room_id=room.id).first():
        return "Not a member of this room", 403
    
    content = request.form.get('message')
    if content:
        message = Message(
            sender_id=user.id,
            room_id=room.id,
            content=content
        )
        db.session.add(message)
        db.session.commit()
    
    return redirect(f'/room/{room_name}')

@app.route('/api/room/<room_name>/password', methods=['POST'])
def change_room_password(room_name):
    if 'user_id' not in session or session.get('role') != 'admin':
        return jsonify({'error': 'Unauthorized'}), 403
    
    room = Room.query.filter_by(name=room_name.capitalize()).first()
    if not room:
        return jsonify({'error': 'Room not found'}), 404
    
    data = request.json
    new_password = data.get('password')
    
    if new_password:
        room.password = generate_password_hash(new_password)
        db.session.commit()
        return jsonify({'success': True})
    
    return jsonify({'error': 'Invalid password'}), 400

@app.route('/logout')
def logout():
    session.clear()
    return redirect('/login')

# ============ INITIALIZATION ============

def init_database():
    """Initialize database with default data"""
    with app.app_context():
        db.create_all()
        create_default_rooms()
        
        # Create admin user if not exists
        if not User.query.filter_by(email='admin@namos.com').first():
            admin = User(
                email='admin@namos.com',
                username='admin',
                password=generate_password_hash('admin123'),
                full_name='Admin User',
                department='Admin',
                role='admin',
                is_verified=True
            )
            db.session.add(admin)
            db.session.commit()
        
        print("‚úÖ Database initialized successfully!")

# ============ RUN APPLICATION ============

if __name__ == '__main__':
    init_database()
    
    print("\n" + "="*60)
    print("üöÄ NAMOS RESTAURANT MANAGEMENT SYSTEM")
    print("="*60)
    print("Server: http://localhost:5000")
    print("\nüîë Default Admin Login:")
    print("   Email: admin@namos.com")
    print("   Password: admin123")
    print("\nüîë Room Passwords:")
    print("   Bar Room: bar123")
    print("   K√ºche Room: kitchen123")
    print("   Service Room: service123")
    print("   Admin Room: admin123")
    print("   Public Room: no password")
    print("="*60)
    
    app.run(debug=True, host='0.0.0.0', port=5000)
